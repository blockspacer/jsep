var WebRTC=function(l,e){function n(b){return"string"==typeof b&&0<b.length}function f(b,a){if(a)a=Error(a),a.number=b,d.onerror(a);else if("string"==typeof b)d.onerror(Error(b));else d.onerror(b)}function w(){try{var a=new XMLHttpRequest;a.onreadystatechange=function(){if(4==a.readyState&&c){if(200!=a.status)return c._datasets=0,c._trycount++,c._trycount>=R?f(a.status,"http-set failed"):e("ERROR: http-set try "+c._trycount+", status is "+a.status);c._trycount=0;c._data.splice(0,c._datasets);c._datasets=
0;var b=JSON.parse(a.responseText);if(0!=b.ret)return f(b.ret,a.responseText);if(0<c._data.length)return w()}};var g=t+"/v1/set/"+c.confNum+"/"+c.instanceId;e("POST "+g);a.open("POST",g);c._datasets=c._data.length;a.setRequestHeader("Content-type","application/json; charset=utf-8");a.send(JSON.stringify({data:c._data}))}catch(S){return f(S)}}function v(a,g){a.from=u;if(h){if(!g)throw Error("invalid peer");a.to=g;h.send(JSON.stringify(a))}else if(c)a.to=g||c.instanceId,c._data.push(JSON.stringify(a)),
0==c._datasets&&w();else return f("invalid state");a.txt?e("&gt&gt"+a.txt):a.ice&&a.ice.candidate?e("&gt&gt"+a.ice.candidate):e("&gt&gt"+a.type)}function C(b,g){a&&a.dc&&"open"==a.dc.readyState?a.dc.send(b):v({txt:b,type:"msg"},g)}function D(){a.heart&&clearTimeout(a.heart);a.dc=null;d.share=null;d.update=null;d.mute=null;x(!0);a.close();y=a=null;e("hangup ok")}function E(b){var g=JSON.parse(b);if(!g)return e("invalid msg: "+b);if("msg"==g.type)return d.onmessage(g.txt,g.from);if("cmd"==g.type)e("&lt&lt"+
g.txt),"hangup"==g.txt&&a&&(D(),d.onhangup());else{g.ice&&g.ice.candidate?e("&lt&lt"+g.ice.candidate):e("&lt&lt"+g.type);try{if(a||(y=!0,d.oncall(g.from)),a&&(g.ice&&a.addIceCandidate(new RTCIceCandidate(g.ice)),g.sdp)){var c;if(d.onremovestream&&n(g.mediaid))for(c in a.remoteStreamTypes)c!=g.mediaid&&c!=g.shareid&&(d.onremovestream(c,a.remoteStreamTypes[c]),delete a.remoteStreamTypes[c]);if(n(g.shareid))a.remoteStreamTypes[g.shareid]="peershare";else if(d.onremovestream)for(c in a.remoteStreamTypes)"peershare"==
a.remoteStreamTypes[c]&&(d.onremovestream(c,"peershare"),delete a.remoteStreamTypes[c]);var k=new RTCSessionDescription(g.sdp);a.setRemoteDescription(k,function(){a&&F(k.type,"remote",k)},f)}}catch(p){return f(p)}}}function G(){if(c){try{var a=new XMLHttpRequest;a.onreadystatechange=function(){if(4==a.readyState&&c){if(200!=a.status)e("ERROR: http-get status "+a.status);else{var b=JSON.parse(a.responseText);if(0!=b.ret)return f(b.ret,a.responseText);b=b.data;if(Array.isArray(b)&&0<b.length)for(var d=
0,k=b.length;d<k;++d)E(b[d])}c.heart=setTimeout(G,H)}};a.open("GET",t+"/v1/get/"+c.confNum+"/"+c.instanceId);a.send()}catch(g){return f(g)}0==c._datasets&&0<c._data.length&&w()}}function F(b,c,d){e("set "+b+" into "+c+" ok");"local"==c&&v({sdp:d,type:"sdp",shareid:a.localShareId,mediaid:a.localStream?a.localStream.id:""},a.peer);if("offer"==b&&"remote"==c)a.onnegotiationneeded()}function I(b){a.setLocalDescription(b,function(){a&&F(b.type,"local",b)},f)}function z(){a&&(v({txt:"hangup",type:"cmd"},
a.peer),D())}function J(){z();h&&(h.heart&&clearTimeout(h.heart),h.close(),h=null);if(c){c.heart&&clearTimeout(c.heart);c.abort();var a;c.instanceId&&c.confNum&&(a=t+"/v1/release/"+c.confNum+"/"+c.instanceId);c=null;if(a){var d=new XMLHttpRequest;d.onreadystatechange=function(){4==d.readyState&&e("http-delete "+(200==d.status?"ok":"failed"))};e("DELETE "+a);d.open("DELETE",a,!0);d.send()}}}function K(b){a&&(a.dc=b,b.onmessage=function(b){if(a)d.onmessage(b.data,a.peer)},b.onopen=function(){e("dc onopen")},
b.onclose=function(){e("dc onclose");a&&(a.dc=null)})}function L(){if(a){a.heart&&clearTimeout(a.heart);a.heart=null;var b=a.signalingState;"have-remote-offer"==b?a.createAnswer(I,f):"stable"==b?a.createOffer(I,f,{offerToReceiveAudio:!0,offerToReceiveVideo:!0}):"closed"!=b&&"have-local-offer"!=b&&(a.heart=setTimeout(L,1E3))}}function x(b){if(a){a.dtmf=null;d.dtmf=null;if(a.localStream){if(!b&&d.onremovestream&&0<a.localStream.getVideoTracks().length)d.onremovestream(a.localStream.id,"localvideo");
var c=a.localStream.getTracks();var e=0;for(b=c.length;e<b;++e)c[e].stop();a.localStream=null}var k=a.getLocalStreams(),p=0;for(b=k.length;p<b;++p)if((c=k[p])&&c.id!=a.localShareId){c=c.getTracks();e=0;for(var f=c.length;e<f;++e)c[e].stop();if(a.removeStream)try{a.removeStream(k[p])}catch(T){}}if(a.senders)try{p=0;for(b=a.senders.length;p<b;++p)a.removeTrack(a.senders[p]);a.senders=null}catch(T){}}}function U(b,c){if(a)for(var d=a.getLocalStreams(),k=0,g=d.length;k<g;++k){for(var e=d[k].getAudioTracks(),
f=0,h=e.length;f<h;++f)e[f].enabled=!b;e=d[k].getVideoTracks();f=0;for(h=e.length;f<h;++f)e[f].enabled=!c}}function M(b){if(a){x();if(a.removeStream)a.addStream(b);else{a.senders=[];var c=b.getTracks();var f=c.length;for(k=0;k<f;++k)a.senders.push(a.addTrack(c[k],b))}y||a.dc||K(a.createDataChannel("data channel"));f=b.getAudioTracks();0<f.length&&(a.dtmf=a.getSenders?a.getSenders()[0].dtmf:a.createDTMFSender(f[0]),a.dtmf&&(a.dtmf.ontonechange=function(a){e("dtmf: "+a.tone)},d.dtmf=function(b,c,d){a&&
a.dtmf&&a.dtmf.insertDTMF(b,c,d)}));f=b.getVideoTracks();a.localStream=b;if(d.onaddstream&&0<f.length)d.onaddstream(a.localStream,"localvideo");a.onnegotiationneeded()}else{c=b.getTracks();var k=0;for(f=c.length;k<f;++k)c[k].stop()}}function N(b){if(a){if("object"==typeof b){if("function"==typeof b.getTracks&&"function"==typeof b.getAudioTracks&&"function"==typeof b.getVideoTracks){e("media object: "+b);M(b);return}if(b.audio||b.video){e("media constraints: "+JSON.stringify(b));navigator.mediaDevices.getUserMedia(b).then(M).catch(f);
return}}e("media closed");x();a.onnegotiationneeded()}}function A(b,g,f){if("function"!=typeof d.onaddstream)throw Error("invalid onaddstream");if("function"!=typeof d.onremovestream)throw Error("invalid onremovestream");!b&&c&&c.config&&(b=c.config);if("object"!=typeof b)throw Error("invalid call arguments");e("call "+JSON.stringify(b));a=new RTCPeerConnection(b);a.peer=f;a.localShareId="";a.remoteStreamTypes={};a.onicecandidate=function(b){b&&b.candidate&&a&&v({ice:b.candidate,type:"ice"},f)};a.onaddstream=
function(b){if(a){var c=a.remoteStreamTypes[b.stream.id];c||(c=0<b.stream.getVideoTracks().length?"peervideo":0<b.stream.getAudioTracks().length?"peeraudio":"peerdata",a.remoteStreamTypes[b.stream.id]=c);if(d.onaddstream)d.onaddstream(b.stream,c)}};a.onremovestream=function(b){if(a){var c=a.remoteStreamTypes[b.stream.id];if(c&&(delete a.remoteStreamTypes[b.stream.id],d.onremovestream))d.onremovestream(b.stream.id,c)}};a.oniceconnectionstatechange=function(a){d.oniceconnectionstatechange(a.currentTarget.iceConnectionState)};
a.onsignalingstatechange=function(a){d.onsignalingstatechange(a.currentTarget.signalingState)};a.ondatachannel=function(a){K(a.channel)};a.onnegotiationneeded=function(){a&&!a.heart&&(a.heart=setTimeout(L,1E3))};N(g);d.share=V;d.update=N;d.mute=U}function V(b,c){if(a)if(b)if(m&&a.localShareId!=m.id){if(a.addStream(m),a.localShareId=m.id,d.onaddstream)d.onaddstream(m,"localshare")}else W(c,function(b,c,g){if(a){if(b){if(d.onremovestream)d.onremovestream(a.localShareId,"localshare");a.localShareId=
"";return e(b)}m||navigator.mediaDevices.getUserMedia(g).then(function(b){m=b;b.getVideoTracks()[0].onended=function(){m=null;if(a&&a.localShareId==b.id){a.removeStream(b);if(d.onremovestream)d.onremovestream(a.localShareId,"localshare");a.localShareId=""}};if(a&&(a.addStream(b),a.localShareId=m.id,d.onaddstream))d.onaddstream(m,"localshare")}).catch(f)}});else if(m&&a.localShareId==m.id){a.removeStream(m);if(d.onremovestream)d.onremovestream(a.localShareId,"localshare");a.localShareId=""}}function X(a){q?
a():(q=document.createElement("iframe"),q.onload=function(){q.isLoaded=!0;a()},q.src=O,q.style.display="none",(document.body||document.documentElement).appendChild(q))}function B(){q?q.isLoaded?q.contentWindow.postMessage({captureSourceId:!0},"*"):setTimeout(B,100):X(B)}if(!this||this==window)return"18032201";if("object"!=typeof l)throw Error("invalid config");var O="https://www.webrtc-experiment.com/getSourceId/",u=l.id,t=l.url,R=l.__HTTP_RETRY__||3,H=l.__HTTP_INTERVAL__||1E3;l.getsourceid&&0==l.getsourceid.indexOf("https://")&&
(O=l.getsourceid);n(u)||(u=Math.random().toString(36).substr(2,4));e||(e=console.debug);var a,y,d=this;d.onerror=console.error;if(0==t.indexOf("ws")){try{var h=new WebSocket(t)}catch(b){return null}h.onerror=function(a){if(h)return f("websocket failed")};h.onopen=function(){e("ws onopen");h.send(JSON.stringify({from:u}));h.heart&&clearTimeout(h.heart);h.heart=null;d.call=A;d.send=C;d.onopen(u)};h.onmessage=function(a){E(a.data)};h.onclose=function(a){h&&(e("ws onclose"),d.call=d.send=null,d.onclose())};
h.heart=setTimeout(function(){return f("ws timeout")},1E4)}else if(0==t.indexOf("http")&&"object"==typeof l.confProps)try{var r=l.confProps;if(!n(r.roomId))throw Error("invalid confProps.roomId");if(!n(r.accountName))throw Error("invalid confProps.accountName");if(!n(r.password))throw Error("invalid confProps.password");if(!n(r.appKey))throw Error("invalid confProps.appKey");if(!n(r.regionId))throw Error("invalid confProps.regionId");var P=t+"/v1/conference/"+r.roomId;delete r.roomId;var Q=JSON.stringify(r);
var c=new XMLHttpRequest;c._data=[];c._datasets=0;c._trycount=0;c.onreadystatechange=function(){if(c&&4==c.readyState){if(200!=c.status)return f(c.status,"http-conference failed");var a=JSON.parse(c.responseText);if(0!=a.ret)return f(a.ret,c.responseText);if(!n(a.data.instanceId))return f("invalid instanceId");if(!n(a.data.confNum))return f("invalid confNum");e("http onopen");c.confNum=a.data.confNum;d.call=A;d.send=C;c.config=a.data;c.instanceId=a.data.instanceId;d.onopen(u,a.data);delete c.config.confNum;
delete c.config.instanceId;c.heart=setTimeout(G,H)}};c.open("POST",P);c.setRequestHeader("Content-type","application/json; charset=utf-8");e("POST "+P+"\n"+Q);l.__TEST_INSTANCE__&&(e("TEST_INSTANCE="+l.__TEST_INSTANCE__),c.setRequestHeader("TEST_INSTANCE",l.__TEST_INSTANCE__));c.send(Q)}catch(b){throw b;}else throw Error("invalid url");d.close=J;d.hangup=z;d.onopen=e;d.oniceconnectionstatechange=e;d.onsignalingstatechange=e;d.onclose=J;d.oncall=A;d.onhangup=z;d.onmessage=e;var m,q,W=function(a,c){function b(a){if(a.data){if(a.data.chromeMediaSourceId)if("PermissionDeniedError"===
a.data.chromeMediaSourceId)c("permission-denied");else{var d=a.data.chromeMediaSourceId;a=a.data.chromeMediaSourceId;var e={audio:!1,video:{mandatory:{chromeMediaSource:"desktop",maxWidth:1920<window.screen.width?window.screen.width:1920,maxHeight:1080<window.screen.height?window.screen.height:1080},optional:[]}};a&&(e.video.mandatory.chromeMediaSourceId=a);c(null,d,e)}window.removeEventListener("message",b)}}navigator.mozGetUserMedia?c(null,"firefox",{video:{mozMediaSource:a||"window",mediaSource:a||
"window"}}):(window.addEventListener("message",b),setTimeout(B,100))}};
